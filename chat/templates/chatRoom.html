{% extends "base.html" %} {% block content %}

<h2>Chat with {{receiver.username}}</h2>

<div id="chatBox">
  {% for msg in messages %}
  <div
    class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}"
  >
    <p><strong>{{ msg.sender.username }}:</strong> {{ msg.text }}</p>
    <span class="timestamp">{{ msg.timestamp|time:"H:i" }}</span>
  </div>

  {% endfor %}
</div>

<form method="post" id="ChatForm">
  {% csrf_token %}
  <input
    type="text"
    id="chatInput"
    placeholder="Type here..."
    name="message"
    required
  />
  <button type="submit">Send</button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const chatBox = document.getElementById("chatBox");
    const chatWith = "{{ receiver.username }}";
    const chatForm = document.getElementById("ChatForm");
    const chatInput = document.getElementById("chatInput");
    const csrfToken = "{{ csrf_token }}";
    let isScrolledToBottom = true;

    chatBox.addEventListener("scroll", () => {
      // Check karein ki user last me hai ya nahi
      isScrolledToBottom =
        chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 10;
    });

    function fetchMessages() {
      fetch(`/messages/${chatWith}/`)
        .then((response) => response.json())
        .then((data) => {
          const oldScrollHeight = chatBox.scrollHeight;
          const oldScrollTop = chatBox.scrollTop;

          chatBox.innerHTML = "";
          data.messages.forEach((msg) => {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            messageElement.classList.add(
              msg.sender === "{{ request.user.username }}" ? "sent" : "received"
            );

            // Timestamp ko proper format me show karna
            const messageTime = new Date(msg.timestamp);
            const formattedTime = messageTime.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });

            messageElement.innerHTML = `
          <p><strong>${msg.sender}:</strong> ${msg.text}</p>
          <span class="timestamp">${formattedTime}</span>
        `;
            chatBox.appendChild(messageElement);
          });

          // Agar user bottom pe tha to hi scroll ko bottom pe le jao
          if (isScrolledToBottom) {
            chatBox.scrollTop = chatBox.scrollHeight;
          } else {
            // Preserve user ka scroll position agar woh manually scroll kar raha hai
            chatBox.scrollTop =
              oldScrollTop + (chatBox.scrollHeight - oldScrollHeight);
          }
        })
        .catch((error) => console.error("Error fetching messages:", error));
    }

    setInterval(fetchMessages, 500);

    // Sending message via AJAX (without reloading)
    chatForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(chatForm);
      chatInput.value = "";

      fetch(`/chat/${chatWith}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
        },
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Server error: " + response.status);
          }
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            return response.json();
          } else {
            throw new Error("Invalid JSON response");
          }
        })
        .then((data) => {
          if (data.error) {
            console.log("Error sending message...");
          } else {
            chatInput.value = "";
            fetchMessages(); // Fetch updated messages instantly
          }
        })
        .catch((error) => console.error("Error sending message:", error));
    });
    fetchMessages();
  });
</script>

{% endblock %}
